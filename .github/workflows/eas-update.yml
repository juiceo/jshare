name: eas-update

on:
    workflow_run:
        workflows: ['test']
        branches: [main]
        types:
            - completed

concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

env:
    EXPO_USE_FAST_RESOLVER: true # Use the faster Metro resolver in SDK 51

jobs:
    mobile:
        runs-on: ubuntu-latest
        steps:
            - name: 🏗 Setup repository
              uses: actions/checkout@v4

            - name: 🏗 Setup monorepo
              uses: ./.github/actions/setup-monorepo
              with:
                  expo-token: ${{ secrets.EXPO_TOKEN }}

            - name: 👷 Build packages
              run: pnpm run -w build:mobile

            - name: 🚀 Update EAS main branch
              uses: expo/expo-github-action/preview@v8
              with:
                  working-directory: apps/mobile
                  command: env-cmd -f .env.staging eas update --auto --non-interactive --branch=main
