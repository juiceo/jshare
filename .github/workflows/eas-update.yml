name: eas-update

on:
    workflow_run:
        workflows: ['test']
        branches: [main]
        types:
            - completed

concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

env:
    EXPO_USE_FAST_RESOLVER: true # Use the faster Metro resolver in SDK 51

jobs:
    mobile:
        runs-on: ubuntu-latest
        steps:
            - name: 🏗 Setup repository
              uses: actions/checkout@v4

            - name: 🏗 Setup monorepo
              uses: ./.github/actions/setup-monorepo
              with:
                  expo-token: ${{ secrets.EXPO_TOKEN }}

            - name: 👷 Build packages
              run: pnpm run -w build:mobile

            - name: 🧐 Compare version with EAS build
              id: compare_versions
              working-directory: apps/mobile
              run: |
                  # Run the comparison script
                  ./scripts/compare-eas-build-number.sh
              continue-on-error: false

            - name: 🚀 Run EAS build (if version is greater)
              if: steps.compare_versions.outputs.result == 'true'
              run: |
                  echo "Version in package.json is greater than latest EAS version. Running EAS build..."

            - name: 🚀 Update EAS production branch (if version is not greater)
              if: steps.compare_versions.outputs.result != 'true'
              working-directory: apps/mobile
              run: |
                  echo "Version in package.json is less than latest EAS version. Running EAS update..."
