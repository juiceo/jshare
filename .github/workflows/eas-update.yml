name: eas-update

on:
    workflow_run:
        workflows: ['test']
        branches: [main]
        types:
            - completed

concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    cancel-in-progress: true

env:
    EXPO_USE_FAST_RESOLVER: true # Use the faster Metro resolver in SDK 51

jobs:
    mobile:
        runs-on: ubuntu-latest
        steps:
            - name: 🏗 Setup repository
              uses: actions/checkout@v4

            - name: 🏗 Setup monorepo
              uses: ./.github/actions/setup-monorepo
              with:
                  expo-token: ${{ secrets.EXPO_TOKEN }}

            - name: 👷 Build packages
              run: pnpm run -w build:mobile

            - name: 🧐 Compare version with EAS build
              id: compare_versions
              working-directory: apps/mobile
              run: |
                  # Run the comparison script
                  ./scripts/compare-eas-build-number.sh
              continue-on-error: false

            - name: 🚀 Update EAS production branch
              working-directory: apps/mobile
              if: "${{ steps.compare_versions.outputs.result == 'false' }}"
              run: |
                  echo "Version in package.json is not greater than latest EAS version. Running EAS update..."
                  pnpm eas:update:production:ci

            - name: 🚀 Version number increased - Run EAS build
              if: "${{ steps.compare_versions.outputs.result == 'true' }}"
              working-directory: apps/mobile
              run: |
                  echo "Version in package.json is greater than latest EAS version. Running EAS build..."
                  pnpm eas:build:production:ci

            - name: 🚀 Version number increased - Run EAS submit
              if: "${{ steps.compare_versions.outputs.result == 'true' }}"
              working-directory: apps/mobile
              run: |
                  echo "Version in package.json is greater than latest EAS version. Running EAS submit..."
                  pnpm eas:submit:production:ci
